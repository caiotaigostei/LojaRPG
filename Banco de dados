
CREATE DATABASE Loja_RPG;
USE Loja_RPG;

CREATE TABLE Cliente (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(100) NOT NULL,
  idade SMALLINT UNSIGNED,
  sexo ENUM('M','F','O'),
  data_nascimento DATE,
  CONSTRAINT unq_nome_data UNIQUE (nome, data_nascimento)
);

CREATE TABLE clientes_especiais (
  cliente_id INT PRIMARY KEY,
  cashback DECIMAL(10,2) DEFAULT 0.00,
  FOREIGN KEY (cliente_id) REFERENCES Cliente(id)
);


CREATE TABLE Cargo (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome ENUM('CEO','Gerente_Produtos','Gerente_Usuarios','Vendedor','Vendedor_VIP') NOT NULL UNIQUE,
  descricao TEXT
);

INSERT INTO Cargo (nome, descricao) VALUES
('CEO', 'Pode excluir o banco inteiro e alterar o acesso de todos.'),
('Gerente_Produtos', 'Pode criar, editar e deletar produtos.'),
('Gerente_Usuarios', 'Pode deletar clientes e zerar cashback.'),
('Vendedor', 'Pode vender produtos normais.'),
('Vendedor_VIP', 'Pode vender produtos premium e tem nota média mais alta.');

CREATE TABLE Vendedor (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(100) NOT NULL,
  causa_social VARCHAR(100) NOT NULL,
  nota_media DECIMAL(3,1) DEFAULT 0.00,
  tipo ENUM('comum','vip') DEFAULT 'comum',
  cargo_id INT,
  FOREIGN KEY (cargo_id) REFERENCES Cargo(id)
);

-- Inserindo vendedores de exemplo
INSERT INTO Vendedor (nome, causa_social, nota_media, tipo, cargo_id) VALUES
('Lucas Ramos', 'Loja dos Aventureiros', 4.3, 'comum', 4),
('Carla Farias', 'Masmorra Encantada', 4.5, 'comum', 4),
('Tiago Sombra', 'RPG e Cia', 4.2, 'comum', 4),
('Elena Duarte', 'Mestres do Dado', 4.9, 'vip', 5),
('Arthur Nunes', 'Tomo da Magia', 4.8, 'vip', 5);


CREATE TABLE Produtos (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(100) NOT NULL,
  descricao TEXT,
  quantidade_em_estoque INT UNSIGNED DEFAULT 0 CHECK(quantidade_em_estoque >= 0),
  valor DECIMAL(10,2) CHECK(valor >= 0),
  observacoes TEXT,
  vendedor_id INT,
  FOREIGN KEY (vendedor_id) REFERENCES Vendedor(id)
);

-- Inserindo 20 produtos normais
INSERT INTO Produtos (nome, descricao, quantidade_em_estoque, valor, observacoes, vendedor_id) VALUES
('Conjunto de Dados Metálicos', 'Conjunto com 7 dados metálicos de RPG.', 15, 149.90, 'Brilho prateado; inclui bolsa.', 1),
('Escudo do Mestre', 'Painel de papelão com tabelas e arte temática.', 10, 89.90, 'Versão genérica, compatível com qualquer sistema.', 1),
('Miniatura de Dragão Vermelho', 'Miniatura detalhada em resina pintada à mão.', 8, 229.90, 'Peça colecionável.', 1),
('Livro de Regras Básicas', 'Manual introdutório para iniciantes em RPG.', 25, 99.90, 'Edição revisada.', 2),
('Livro do Mestre', 'Guia completo para mestres.', 10, 159.90, 'Inclui dicas de criação de mundos.', 2),
('Aventuras Prontas – Volume I', 'Coleção de aventuras para campanhas curtas.', 20, 119.90, 'Contém 5 histórias completas.', 2),
('Mapa de Mundo de RPG', 'Mapa laminado com marcadores.', 12, 59.90, 'Tamanho A2.', 3),
('Conjunto de Miniaturas – Heróis', 'Pacote com 6 miniaturas de personagens heróicos.', 18, 129.90, 'Feitas em plástico rígido.', 3),
('Tela do Mestre de Couro', 'Tela artesanal em couro sintético.', 5, 249.90, 'Produção limitada.', 3),
('Livro de Magias Avançadas', 'Compêndio de magias e feitiços raros.', 8, 179.90, 'Edição com capa dura.', 1),
('Kit de Iniciação RPG', 'Pacote completo para novos jogadores.', 20, 199.90, 'Inclui dados, fichas e livro digital.', 2),
('Conjunto de Dados Translúcidos', 'Dados coloridos transparentes.', 25, 69.90, 'Cores sortidas.', 3),
('Ficha de Personagem Premium', 'Bloco com 50 fichas de personagem.', 30, 39.90, 'Papel 120g.', 3),
('Livro de Criaturas e Bestiário', 'Catálogo de monstros para RPG.', 12, 159.90, 'Ilustrações coloridas.', 2),
('Miniatura de Lich', 'Miniatura sombria com detalhes metálicos.', 7, 189.90, 'Edição limitada.', 1),
('Kit Mestre de Campanha', 'Conjunto de acessórios para mestres.', 6, 259.90, 'Inclui tela, mapa e fichas.', 1),
('Livro de Aventuras Épicas', 'Histórias avançadas para grupos experientes.', 10, 179.90, 'Capa dura.', 2),
('Escudo Arcano', 'Escudo mágico decorativo de RPG.', 5, 209.90, 'Feito em madeira e resina.', 3),
('Dado Gigante d20', 'Dado de 10 cm de diâmetro para eventos.', 15, 49.90, 'Material: acrílico.', 2),
('Livro do Jogador Avançado', 'Manual expandido com regras e classes novas.', 9, 189.90, 'Edição de luxo.', 1);

-- Inserindo 5 produtos exclusivos de vendedores VIP
INSERT INTO Produtos (nome, descricao, quantidade_em_estoque, valor, observacoes, vendedor_id) VALUES
('Relíquia do Dragão Ancião', 'Item lendário usado em campanhas épicas.', 2, 799.90, 'Somente disponível para jogadores experientes.', 4),
('Dado de Cristal Arcano', 'Dado artesanal feito de cristal lapidado.', 3, 999.90, 'Acompanha certificado de autenticidade.', 4),
('Livro Perdido de Arkanum', 'Tomo místico com magias esquecidas.', 1, 1199.90, 'Capa feita de couro verdadeiro.', 4),
('Espada Cerimonial do Abismo', 'Réplica de arma lendária de RPG.', 2, 899.90, 'Feita sob encomenda.', 5),
('Coleção Lendária – Set Completo', 'Caixa com todos os livros premium da loja.', 1, 1499.90, 'Produto exclusivo VIP.', 5);


CREATE TABLE transportadoras (
  id INT AUTO_INCREMENT PRIMARY KEY,
  nome VARCHAR(100) NOT NULL,
  cidade VARCHAR(100)
);


CREATE TABLE Venda (
  id INT AUTO_INCREMENT PRIMARY KEY,
  cliente_id INT,
  transportadora_id INT,
  data_hora DATETIME DEFAULT NOW(),
  endereco_des VARCHAR(100),
  valor_transp DECIMAL(10,2) DEFAULT 0.00 CHECK(valor_transp >= 0),
  FOREIGN KEY (cliente_id) REFERENCES Cliente(id),
  FOREIGN KEY (transportadora_id) REFERENCES transportadoras(id)
);

CREATE TABLE venda_produtos (
  venda_id INT,
  produto_id INT,
  quantidade INT UNSIGNED DEFAULT 1 CHECK(quantidade > 0),
  PRIMARY KEY (venda_id, produto_id),
  FOREIGN KEY (venda_id) REFERENCES Venda(id),
  FOREIGN KEY (produto_id) REFERENCES Produtos(id)
);


CREATE TABLE sistema_controle (
  id INT AUTO_INCREMENT PRIMARY KEY,
  comando VARCHAR(50) NOT NULL,
  data_execucao DATETIME DEFAULT NOW()
);

SET @cargo_ativo = 'Vendedor';



DELIMITER //
CREATE TRIGGER trg_bloquear_criacao_produtos
BEFORE INSERT ON Produtos
FOR EACH ROW
BEGIN
  IF @cargo_ativo NOT IN ('Gerente_Produtos', 'CEO') THEN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = ' Apenas o Gerente de Produtos ou CEO pode criar produtos.';
  END IF;
END;
//
DELIMITER ;

DELIMITER //
CREATE TRIGGER trg_bloquear_exclusao_produtos
BEFORE DELETE ON Produtos
FOR EACH ROW
BEGIN
  IF @cargo_ativo NOT IN ('Gerente_Produtos', 'CEO') THEN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = ' Apenas o Gerente de Produtos ou CEO pode excluir produtos.';
  END IF;
END;
//
DELIMITER ;

DELIMITER //
CREATE TRIGGER trg_bloquear_exclusao_clientes
BEFORE DELETE ON Cliente
FOR EACH ROW
BEGIN
  IF @cargo_ativo NOT IN ('Gerente_Usuarios', 'CEO') THEN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = ' Apenas o Gerente de Usuários ou CEO pode excluir clientes.';
  END IF;
END;
//
DELIMITER ;

DELIMITER //
CREATE TRIGGER trg_bloquear_alteracao_cashback
BEFORE UPDATE ON clientes_especiais
FOR EACH ROW
BEGIN
  IF @cargo_ativo NOT IN ('Gerente_Usuarios', 'CEO') THEN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'Apenas o Gerente de Usuários ou CEO pode alterar cashback.';
  END IF;
END;
//
DELIMITER ;

DELIMITER //
CREATE TRIGGER trg_autodestruicao_ceo
AFTER INSERT ON sistema_controle
FOR EACH ROW
BEGIN
  IF NEW.comando = 'AUTODESTRUIR' THEN
    IF @cargo_ativo = 'CEO' THEN
      DELETE FROM venda_produtos;
      DELETE FROM Venda;
      DELETE FROM Produtos;
      DELETE FROM Cliente;
      DELETE FROM clientes_especiais;
      DELETE FROM Vendedor;
      DELETE FROM transportadoras;
      DELETE FROM Cargo;

      INSERT INTO sistema_controle (comando) VALUES ('BANCO_AUTODESTRUIDO');
    ELSE
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = ' Apenas o CEO pode executar AUTODESTRUIR.';
    END IF;
  END IF;
END;
//
DELIMITER ;
